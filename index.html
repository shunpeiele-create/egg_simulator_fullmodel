<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>EGG MOUSE SIMULATOR v147</title>
    
    <link rel="apple-touch-icon" href="image/top.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #f8f8f8; --panel-bg: #ffffff; --border: #e5e5ea;
            --text-sub: #8e8e93; --alert: #ff3b30; --disabled: #d1d1d6; --overlay-dim: rgba(0,0,0,0.4);
        }
        
        * { 
            box-sizing: border-box; -webkit-tap-highlight-color: transparent; 
            -webkit-user-select: none; -webkit-touch-callout: none;
            user-select: none; outline: none; 
            font-family: 'Futura PT', Futura, 'Noto Sans JP', sans-serif;
        }

        html, body { 
            margin: 0; padding: 0; background: var(--primary-bg); 
            overflow: hidden; height: 100%; width: 100%; position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
        }

        small { font-weight: 400 !important; }

        #global-guard { position: fixed; inset: 0; z-index: 99999; display: none; }
        .manual-saver-trigger { position: fixed; top: 0; left: 0; width: 80px; height: 80px; z-index: 10000; cursor: pointer; }
        .admin-trigger { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; background: none; border: none; cursor: pointer; font-size: 28px; color: #eee; z-index: 15000; display: flex; justify-content: center; align-items: center; }

        .app-grid { display: grid; grid-template-columns: 1.6fr 1fr; height: 100%; width: 100%; position: relative; }
        .preview-pane { background: #fff; border-right: 1px solid var(--border); position: relative; display: flex; flex-direction: column; overflow: hidden; z-index: 10; }
        .control-pane { background: var(--panel-bg); padding: 50px 35px 40px; display: flex; flex-direction: column; position: relative; z-index: 10; height: 100%; overflow: hidden; }
        
        .ui-part { transition: 0.4s; opacity: 1; }
        .saver-active .ui-part { opacity: 0; pointer-events: none; }

        .title-area { position: absolute; top: 60px; left: 0; width: 100%; height: 60px; display: flex; justify-content: center; z-index: 20; pointer-events: none; }
        .preview-outer { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; height: 100%; }
        .default-img { position: absolute; width: 90%; max-height: 70%; object-fit: contain; z-index: 1; transition: opacity 0.8s ease; }
        
        .preview-wrapper { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(1); height: 55%; aspect-ratio: 179 / 232; display: flex; justify-content: center; align-items: center; z-index: 2; opacity: 0; }
        .preview-wrapper.animate-on { transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity: 0.4s ease; }
        .preview-wrapper.rise { transform: translate(-50%, -65%) scale(1.15); opacity: 1 !important; filter: drop-shadow(0 30px 20px rgba(0,0,0,0.15)); }

        @keyframes snapLaunch {
            0% { transform: translate(-50%, -65%) scale(1.15); opacity: 1; }
            15% { transform: translate(-50%, -45%) scale(1.0); opacity: 1; }
            30% { transform: translate(-50%, -75%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200vh) scale(0.2); opacity: 0; }
        }
        .preview-wrapper.fly { animation: snapLaunch 1.1s cubic-bezier(0.45, 0, 0.55, 1) forwards !important; }
        .layer { position: absolute; width: 100%; height: 100%; object-fit: contain; transition: 0.4s ease; }

        .section { margin-bottom: 40px; transition: opacity 0.4s ease; transform-origin: center top; }
        .section.locked { opacity: 0.15; pointer-events: none; }
        .section-label { font-size: 17px; font-weight: 900; color: #000; margin-bottom: 12px; display: block; letter-spacing: 0.05em; }
        
        .grid-colors { display: flex; gap: 16px; flex-wrap: wrap; }
        .color-dot { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border); overflow: hidden; background-size: 180%; background-position: center 10%; cursor: pointer; position: relative; }
        .color-dot.active::after { content: ''; position: absolute; inset: 0; border: 3px solid #000; border-radius: 50%; }
        
        .grid-covers { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; width: 100%; }
        .cover-item { aspect-ratio: 1.1; border: 1px solid var(--border); border-radius: 10px; background: #fff; display: flex; justify-content: center; align-items: center; padding: 4px; cursor: pointer; }
        .cover-item.active { border: 2.5px solid #000; background: #fafafa; }
        .cover-thumb { width: 55%; height: 55%; object-fit: contain; }

        .community-area-box { flex: 1; position: relative; overflow: hidden; background: #fcfcfc; border-radius: 20px; border: 1px dashed var(--border); cursor: grab; touch-action: none; z-index: 5; margin-bottom: 25px; min-height: 100px; }
        #saver-layer { position: fixed; inset: 0; background: #fff; z-index: 9000; display: none; cursor: grab; touch-action: none; }
        body.saver-active #saver-layer { display: block; }
        
        .community-item { position: absolute; width: 34px; height: 44px; pointer-events: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); will-change: left, top, transform; backface-visibility: hidden; transition: width 0.8s, height 0.8s, opacity 0.5s; }

        @keyframes unlockBounce { 0% { transform: translateY(0); } 40% { transform: translateY(-15px); } 100% { transform: translateY(0); } }
        .is-unlocking { animation: unlockBounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        #saver-guide { position: fixed; bottom: 60px; right: 60px; width: 540px; opacity: 0; transition: 0.5s; z-index: 11000; pointer-events: none; cursor: pointer; }

        .submit-btn { width: 100%; padding: 22px; background: #000; color: #fff; border: none; border-radius: 20px; font-size: 20px; font-weight: 900; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; letter-spacing: 0.08em; }
        .submit-btn:disabled { background: var(--disabled); color: #8e8e93; }

        #cover-alert { color: var(--alert); font-weight: 900; min-height: 1.4em; margin-bottom: 10px; display: block; }

        .overlay { position: fixed; inset: 0; background: var(--overlay-dim); z-index: 50000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.4s ease; }
        .overlay.show { display: flex; opacity: 1; }
        
        .survey-card { background: #fff; width: 92%; max-width: 1280px; height: 72%; border-radius: 40px; overflow: hidden; display: grid; grid-template-columns: 1.1fr 1.2fr; box-shadow: 0 40px 100px rgba(0,0,0,0.3); }
        .survey-preview { background: #f9f9f9; display: flex; justify-content: center; align-items: center; padding: 50px; position: relative; overflow: hidden; }
        .survey-preview .preview-wrapper { height: 60%; width: 60%; max-height: 60%; max-width: 60%; opacity: 1 !important; }
        .survey-form { padding: 40px 60px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        
        .chip { padding: 14px 22px; border: 1px solid var(--border); border-radius: 12px; background: #fff; font-weight: 700; cursor: pointer; font-size: 14px; margin: 0 8px 8px 0; display: inline-block; }
        .chip.active { background: #000; color: #fff; }

        .agree-label { display: flex; align-items: center; gap: 12px; font-weight: 900; margin-bottom: 35px; cursor: pointer; color: var(--alert); white-space: nowrap; }

        #thanks-overlay { 
            position: absolute; inset: 0; 
            background: rgba(255,255,255,0.92); 
            display: none; justify-content: center; align-items: center; 
            z-index: 500; flex-direction: column; opacity: 0; transition: opacity 0.4s ease; 
        }
        #thanks-overlay.show { display: flex; opacity: 1; }

        .admin-menu { background: #fff; padding: 40px; border-radius: 30px; width: 500px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.1); }
        .admin-btn { width: 100%; padding: 18px; margin: 5px 0; border: 1px solid #ddd; background: #fff; font-weight: 900; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body onpointerdown="resetInactivityTimer(event)">

<div id="global-guard"></div>
<button class="admin-trigger ui-part" onclick="openAdmin()">⚙</button>
<div class="manual-saver-trigger" onclick="startSaver()"></div>

<div id="saver-layer">
    <img id="saver-bg-img" src="image/saver_bg.png" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); max-width:60%; opacity:0.05; pointer-events:none;" onerror="this.style.display='none'">
</div>
<img id="saver-guide" src="image/guide.png" onpointerdown="stopSaver(event)" onerror="this.style.display='none'">

<div class="app-grid" id="main-container">
    <div class="preview-pane ui-part">
        <div class="title-area"><img src="title.png" class="title-img" onerror="this.style.opacity=0"></div>
        <div class="preview-outer">
            <img id="img-default" src="image/default.png" class="default-img">
            <div id="main-preview" class="preview-wrapper animate-on">
                <img id="img-base" class="layer"><img id="img-cover" class="layer">
            </div>
        </div>
        <div id="thanks-overlay">
            <div style="font-size: 80px; margin-bottom: 20px;">✓</div>
            <h2 style="font-size: 42px; font-weight: 900; margin: 0;">THANK YOU</h2>
            <p style="font-size: 18px; font-weight: 700; margin-top: 10px;">ご投票ありがとうございました <br><small>(Thank you for your post)</small></p>
        </div>
    </div>
    <div class="control-pane ui-part">
        <div style="flex:1; display:flex; flex-direction:column; min-height:0;">
            <section class="section" id="section-base"><span class="section-label">01. SELECT BODY COLOR  <small>(本体色を選択してください)</small></span><div class="grid-colors" id="base-options"></div></section>
            <section class="section locked" id="section-cover"><span class="section-label">02. CHOOSE COVER  <small>(カバーを選択してください)</small></span><div class="grid-covers" id="cover-options"></div></section>
            <span class="section-label">COMMUNITY <small>(みんなのEGG MOUSE)</small></span>
            <div id="community-area" class="community-area-box"></div>
            <div style="font-size:12px; color:var(--text-sub); text-align:right; margin-top:5px; font-weight:900;">Latest 20 posts <small>(最新の20件)</small></div>
        </div>
        <div id="btn-container">
            <div id="cover-alert" class="alert-text">Please choose a cover <small>(カバーを選んでください)</small></div>
            <button id="submitBtn" class="submit-btn" onclick="handlePostAction()" disabled><span>POST NOW</span><small>投稿する</small></button>
        </div>
    </div>
</div>

<div id="survey-overlay" class="overlay">
    <div class="survey-card">
        <div class="survey-preview" id="survey-clone-target"></div>
        <div class="survey-form">
            <h2 style="font-size:36px; font-weight:900; margin-bottom:10px; letter-spacing:0.02em;">This is your EGG MOUSE!</h2>
            <p style="font-size:16px; color:var(--text-sub); margin-bottom:30px; font-weight:700;">アンケートにご協力ください（任意）<br><span style="font-weight:400;">Please help us with our survey (Optional)</span></p>
            <div id="age-chips"><span class="section-label" style="font-size:18px;">年齢 Age</span><div class="chip" onclick="setSurvey('age','30歳未満')">30歳未満 <small>(Under 30)</small></div><div class="chip" onclick="setSurvey('age','30代')">30代 <small>(30s)</small></div><div class="chip" onclick="setSurvey('age','40代')">40代 <small>(40s)</small></div><div class="chip" onclick="setSurvey('age','50歳以上')">50歳以上 <small>(Over 50)</small></div><div class="chip" onclick="setSurvey('age','選択しない')">選択しない <small>(N/A)</small></div></div>
            <div id="gender-chips" style="margin-top:20px;"><span class="section-label" style="font-size:18px;">性別 Gender</span><div class="chip" onclick="setSurvey('gender','男性')">男性 <small>(Male)</small></div><div class="chip" onclick="setSurvey('gender','女性')">女性 <small>(Female)</small></div><div class="chip" onclick="setSurvey('gender','選択しない')">選択しない <small>(N/A)</small></div></div>
            <div style="font-size:11px; color:var(--text-sub); line-height:1.6; margin:20px 0 30px; padding:20px; background:#f2f2f7; border-radius:15px; font-weight:700;">【個人情報の取り扱い】ご入力いただいた情報は統計データとして活用いたします。特定の個人を識別する目的では使用いたしません。<br><span style="font-weight:400;">[Privacy Policy] Data used only for statistical purposes.</span></div>
            <label class="agree-label">
                <input type="checkbox" id="agree-cb" style="width:28px; height:28px; accent-color:#000;" onchange="updateFinalBtn()">
                <span>個人情報の取り扱い事項に同意する <small>(Agree to the privacy policy)</small></span>
            </label>
            <div style="display:flex; gap:15px;"><button class="submit-btn" style="background:#eee; color:#000; flex:1;" onclick="hideSurvey()">戻る <small>Back</small></button><button id="finalPostBtn" class="submit-btn" style="flex:2;" onclick="executeFinalPost()" disabled>POST NOW <small>投稿する</small></button></div>
        </div>
    </div>
</div>

<div id="admin-overlay" class="overlay">
    <div class="admin-menu">
        <h2 style="margin-bottom:25px; font-weight:900;">EGG MOUSE SIMULATOR SETTINGS</h2>
        <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 20px; background:#f2f2f7; border-radius:15px; margin-bottom:15px; cursor:pointer;" onclick="toggleSurveySetting()">
            <span style="font-weight:900;">Survey Form (アンケート表示)</span><span id="survey-status-label" style="font-weight:900;">ON</span>
        </div>
        <button onclick="downloadCSV()" class="admin-btn">CSV DOWNLOAD</button>
        <button onclick="resetData()" class="admin-btn" style="color:red; border-color:red;">RESET ALL DATA</button>
        <button onclick="closeAdmin()" class="admin-btn" style="background:#eee; border:none; margin-top:20px;">CLOSE</button>
    </div>
</div>

<script>
    const CONFIG = { storageKey: 'egg_mouse_v131_data', settingsKey: 'egg_mouse_v130_set', inactivityLimit: 60000, baseCount: 5, coverMax: 11, maxItems: 20 };
    let communityItems = [], inactivityTimer, isSaverActive = false, grabbedItem = null;
    let selectedBase = null, selectedCover = null, validCoverIdsForRandom = [];
    let surveyInput = { age: '', gender: '' }, isSurveyEnabled = true;

    document.addEventListener('touchmove', function(e) { e.preventDefault(); }, { passive: false });

    function init() {
        const set = JSON.parse(localStorage.getItem(CONFIG.settingsKey) || '{"survey":true, "pw":"1234"}');
        isSurveyEnabled = set.survey; updateSurveyUI();
        const bc = document.getElementById('base-options');
        for(let i=1; i<=CONFIG.baseCount; i++){
            const d = document.createElement('div'); d.className='color-dot'; d.style.backgroundImage=`url(image/base_${i}.png)`; d.onclick=()=>selectBase(i); bc.appendChild(d);
        }
        const cc = document.getElementById('cover-options');
        for(let i=0; i<=CONFIG.coverMax; i++){
            const itm = document.createElement('div'); itm.className='cover-item';
            cc.appendChild(itm); 
            if(i===0){ 
                itm.innerHTML=`<span style="font-weight:900;font-size:10px;text-align:center;">REMOVE<br>COVER</span>`; 
                itm.onclick=()=>selectCover(i); 
            } else {
                const img = new Image(); img.src=`image/cover_${i}.png`; img.className='cover-thumb';
                img.onload=()=>{ itm.appendChild(img); itm.onclick=()=>selectCover(i); validCoverIdsForRandom.push(i); };
                img.onerror=()=>itm.remove();
            }
        }
        cc.style.gridTemplateColumns = `repeat(4, 1fr)`;
        setTimeout(()=>loadCommunity(true), 1000);
        requestAnimationFrame(updateAnimation);
        resetInactivityTimer();
        const touchTargets = [document.getElementById('community-area'), document.getElementById('saver-layer')];
        touchTargets.forEach(t => { t.addEventListener('pointerdown', onPointerDown, { passive: false }); });
        window.addEventListener('pointermove', onPointerMove, { passive: false });
        window.addEventListener('pointerup', ()=>grabbedItem=null);
    }

    function triggerBounce(el) { el.classList.remove('is-unlocking'); void el.offsetWidth; el.classList.add('is-unlocking'); }
    function handlePostAction() { if (isSurveyEnabled) showSurvey(); else executeFinalPost(); }
    
    function executeFinalPost() {
        document.getElementById('global-guard').style.display = 'block';
        if (isSurveyEnabled) hideSurvey();
        const p = document.getElementById('main-preview');
        p.classList.remove('rise', 'fly'); void p.offsetWidth; p.classList.add('fly'); 
        
        // 統計データ保存（isInitial=false相当）
        localStorage.setItem(CONFIG.storageKey, JSON.stringify([...JSON.parse(localStorage.getItem(CONFIG.storageKey)||'[]'), {t:new Date().toLocaleString(), b:selectedBase, c:selectedCover, age:surveyInput.age, gen:surveyInput.gender}]));
        
        setTimeout(() => {
            addCommunityItem(selectedBase, selectedCover, false);
            const th = document.getElementById('thanks-overlay'); th.style.display = 'flex'; setTimeout(() => th.classList.add('show'), 10);
            setTimeout(() => { resetUIState(); th.classList.remove('show'); setTimeout(() => { th.style.display = 'none'; document.getElementById('global-guard').style.display = 'none'; }, 400); }, 1600);
        }, 950); 
    }

    function selectBase(id){
        selectedBase = id; document.getElementById('img-default').style.opacity='0'; 
        const p = document.getElementById('main-preview'); p.style.opacity='1'; p.classList.remove('rise', 'fly');
        document.querySelectorAll('.color-dot').forEach((el,idx)=>el.classList.toggle('active', (idx+1)===id));
        const cs = document.getElementById('section-cover'); cs.classList.remove('locked');
        triggerBounce(cs); updatePreview();
    }
    function selectCover(id){
        if(!selectedBase) return; selectedCover = id;
        document.querySelectorAll('.cover-item').forEach(el=>{ const isNone=el.innerText.includes('REMOVE')&&id===0; const hasMatch=el.querySelector('img')&&el.querySelector('img').src.includes(`cover_${id}.png`); el.classList.toggle('active', isNone||hasMatch); });
        
        const alertEl = document.getElementById('cover-alert');
        if(id === 0) {
            alertEl.innerHTML = 'Please choose a cover <small>(カバーを選んでください)</small>';
            document.getElementById('submitBtn').disabled = true;
        } else {
            alertEl.innerHTML = '&nbsp;'; 
            document.getElementById('submitBtn').disabled = false;
            triggerBounce(document.getElementById('submitBtn'));
        }
        updatePreview();
    }
    function resetUIState(){
        const p = document.getElementById('main-preview'); p.style.opacity='0'; p.classList.remove('rise','fly');
        selectedBase=null; selectedCover=null; document.getElementById('img-default').style.opacity='1';
        document.querySelectorAll('.color-dot, .cover-item, .chip').forEach(el=>el.classList.remove('active'));
        surveyInput = { age: '', gender: '' }; document.getElementById('agree-cb').checked = false;
        document.getElementById('section-cover').classList.add('locked'); document.getElementById('submitBtn').disabled=true;
        document.getElementById('cover-alert').innerHTML = 'Please choose a cover <small>(カバーを選んでください)</small>';
    }
    function showSurvey(){
        const target=document.getElementById('survey-clone-target'); target.innerHTML='';
        const clone=document.getElementById('main-preview').cloneNode(true); clone.style.opacity='1'; clone.classList.remove('animate-on','rise','fly');
        clone.style.top = "50%"; clone.style.left = "50%"; clone.style.transform = "translate(-50%, -50%) scale(1)";
        target.appendChild(clone);
        document.getElementById('agree-cb').checked = false; document.getElementById('finalPostBtn').disabled = true;
        surveyInput = { age: '', gender: '' }; document.querySelectorAll('#survey-overlay .chip').forEach(c => c.classList.remove('active'));
        document.getElementById('survey-overlay').classList.add('show');
    }
    function hideSurvey(){ document.getElementById('survey-overlay').classList.remove('show'); }
    function setSurvey(k,v){ surveyInput[k]=v; document.querySelectorAll(`#${k}-chips .chip`).forEach(c=>c.classList.toggle('active', c.innerText.includes(v))); }
    function updateFinalBtn(){ document.getElementById('finalPostBtn').disabled = !document.getElementById('agree-cb').checked; }

    // パスワードをソースコード内に固定（緊急対応用）
    function openAdmin(){ 
        const MASTER_PW = "8056"; 
        const pw = prompt("Password"); 
        if(pw === MASTER_PW) { 
            document.getElementById('admin-overlay').classList.add('show'); 
        } else if(pw !== null) { 
            alert("Incorrect password"); 
        } 
    }

    function closeAdmin(){ document.getElementById('admin-overlay').classList.remove('show'); }
    function toggleSurveySetting(){ isSurveyEnabled=!isSurveyEnabled; const s = JSON.parse(localStorage.getItem(CONFIG.settingsKey)||'{}'); s.survey=isSurveyEnabled; localStorage.setItem(CONFIG.settingsKey, JSON.stringify(s)); updateSurveyUI(); }
    function updateSurveyUI(){ const l=document.getElementById('survey-status-label'); l.innerText=isSurveyEnabled?'ON':'OFF'; l.style.color=isSurveyEnabled?'#34c759':'#8e8e93'; }

    function onPointerDown(e){ 
        if(e.cancelable) e.preventDefault(); 
        const target = isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area'); 
        const rect = target.getBoundingClientRect(); 
        const tx = ((e.clientX - rect.left) / rect.width) * 100, ty = ((e.clientY - rect.top) / rect.height) * 100; 
        let found = null; 
        communityItems.forEach(i=>{ 
            const hr = isSaverActive ? 6.5 : 4.5; 
            if(Math.sqrt((tx-i.x)**2+(ty-i.y)**2) < hr) found=i; 
        }); 
        if(found){ 
            grabbedItem=found; grabbedItem.vx=0; grabbedItem.vy=0; 
        } else { 
            communityItems.forEach(i=>{ 
                const dx=i.x-tx, dy=i.y-ty, d=Math.sqrt(dx*dx+dy*dy), r=isSaverActive?20:15; 
                if(d < r){ 
                    i.vx+=(dx/d)*(r-d)*0.6; i.vy+=(dy/d)*(r-d)*0.6; 
                    i.dr+=(Math.random()-0.5)*15; 
                } 
            }); 
        } 
    }
    
    function onPointerMove(e){ 
        if(!grabbedItem)return; 
        if(e.cancelable) e.preventDefault(); 
        const target = isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area'); 
        const rect = target.getBoundingClientRect(); 
        const tx=((e.clientX-rect.left)/rect.width)*100, ty=((e.clientY-rect.top)/rect.height)*100; 
        grabbedItem.vx = (tx - grabbedItem.x) * 0.85; grabbedItem.vy = (ty - grabbedItem.y) * 0.85; 
        grabbedItem.x = tx; grabbedItem.y = ty; 
    }
    
    function updateAnimation(){
        const lx=isSaverActive?92:90, ly=isSaverActive?90:80, md=isSaverActive?7:8; 
        for(let i=0; i<communityItems.length; i++){
            for(let j=i+1; j<communityItems.length; j++){
                const a=communityItems[i], b=communityItems[j]; if(a===grabbedItem||b===grabbedItem)continue;
                const dx=b.x-a.x, dy=b.y-a.y, d = Math.sqrt(dx*dx + dy*dy);
                if(d < md && d > 0.1){ 
                    const ang = Math.atan2(dy, dx);
                    let f;
                    if (isSaverActive) {
                        if (d < 5.5) f = 0.9; else f = (md - d) * 0.04;
                    } else {
                        if (d < 7.5) f = 1.5; else f = (md - d) * 0.16;
                    }
                    a.vx -= Math.cos(ang) * f; a.vy -= Math.sin(ang) * f;
                    b.vx += Math.cos(ang) * f; b.vy += Math.sin(ang) * f;
                }
            }
        }
        communityItems.forEach(i=>{
            if(i.scale < 1) { i.scale += 0.04; if(i.scale > 1) i.scale = 1; }
            if(i !== grabbedItem){ 
                i.x+=(i.dx+i.vx); i.y+=(i.dy+i.vy); i.rot+=i.dr; 
                i.vx = Math.max(-10, Math.min(10, i.vx)); i.vy = Math.max(-10, Math.min(10, i.vy));
                i.vx*=0.98; i.vy*=0.98; i.dr*=0.99; 
                if(i.x < 0){ i.x=0; i.dx=Math.abs(i.dx); i.vx*=-0.8; } else if(i.x > lx){ i.x=lx; i.dx=-Math.abs(i.dx); i.vx*=-0.8; }
                if(i.y < 0){ i.y=0; i.dy=Math.abs(i.dy); i.vy*=-0.8; } else if(i.y > ly){ i.y=ly; i.dy=-Math.abs(i.dy); i.vy*=-0.8; }
            }
            i.el.style.left = i.x + '%'; i.el.style.top = i.y + '%'; 
            i.el.style.transform = `rotate(${i.rot}deg) scale(${i.scale}) translateZ(0)`;
        });
        requestAnimationFrame(updateAnimation);
    }
    
    function resetInactivityTimer(){ clearTimeout(inactivityTimer); inactivityTimer=setTimeout(()=>startSaver(), CONFIG.inactivityLimit); }
    function startSaver(){ 
        if(isSaverActive)return; isSaverActive=true; 
        document.body.classList.add('saver-active'); 
        communityItems.forEach(i => { document.getElementById('saver-layer').appendChild(i.el); i.el.style.width = "80px"; i.el.style.height = "104px"; }); 
        document.getElementById('saver-guide').style.opacity = 1; document.getElementById('saver-guide').style.pointerEvents = 'auto'; 
    }
    function stopSaver(e){ 
        if(e) e.stopPropagation(); isSaverActive = false; 
        document.body.classList.remove('saver-active'); 
        communityItems.forEach(i => { document.getElementById('community-area').appendChild(i.el); i.el.style.width = "34px"; i.el.style.height = "44px"; }); 
        document.getElementById('saver-guide').style.opacity = 0; document.getElementById('saver-guide').style.pointerEvents = 'none'; 
        resetInactivityTimer(); 
    }
    function updatePreview(){ document.getElementById('img-base').src=`image/base_${selectedBase}.png`; const c=document.getElementById('img-cover'); if(selectedCover>0){ c.src=`image/cover_${selectedCover}.png`; c.style.opacity="1"; } else { c.style.opacity="0"; } }
    
    function loadCommunity(it){ 
        if(it){ 
            // 最初の5つを生成
            for(let i=0; i<5; i++){ 
                if(validCoverIdsForRandom.length) addCommunityItem(Math.floor(Math.random()*5)+1, validCoverIdsForRandom[Math.floor(Math.random()*validCoverIdsForRandom.length)], true); 
            } 
        } 
    }

    function addCommunityItem(b,c,isInitial){ 
        // 最大数制限のチェック: 20個を超えていたら一番古い(配列の先頭)を削除
        if(communityItems.length >= CONFIG.maxItems) {
            const oldest = communityItems.shift();
            oldest.el.style.opacity = '0'; // 消える演出
            setTimeout(() => oldest.el.remove(), 500);
        }

        const el=document.createElement('div'); el.className='community-item'; 
        el.style.width = "34px"; el.style.height = "44px";
        el.innerHTML=`<img src="image/base_${b}.png" style="width:100%;position:absolute;"><img src="image/cover_${c}.png" style="width:100%;position:absolute;opacity:${c===0?0:1}" onerror="this.style.opacity=0">`; 
        
        const it={
            el,
            x:Math.random()*80+5,
            y:Math.random()*70+5,
            rot:Math.random()*360,
            dx:(Math.random()-0.5)*0.10,
            dy:(Math.random()-0.5)*0.10,
            dr:(Math.random()-0.5)*15,
            vx:0, vy:0,
            scale: isInitial ? 1 : 0 
        }; 
        (isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area')).appendChild(el); 
        communityItems.push(it);
    }

    function downloadCSV(){ const d = JSON.parse(localStorage.getItem(CONFIG.storageKey)||'[]'); const csv = "\ufeffTime,Base,Cover,Age,Gender\n" + d.map(i=>`${i.t},${i.b},${i.c},${i.age},${i.gen}`).join("\n"); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'})); a.download = `booth_results.csv`; a.click(); }
    function resetData(){ if(confirm("Reset ALL data and Community?")) { localStorage.removeItem(CONFIG.storageKey); communityItems.forEach(i => i.el.remove()); communityItems = []; location.reload(); } }
    init();
</script>
</body>
</html>
