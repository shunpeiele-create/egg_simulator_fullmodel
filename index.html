<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Booth Posting Tool v93</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-bg: #f8f8f8;
            --panel-bg: #ffffff;
            --border: #e5e5ea;
            --text-sub: #8e8e93;
            --alert: #ff3b30;
            --disabled: #d1d1d6;
            --overlay-dim: rgba(0,0,0,0.4);
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            outline: none; 
            font-family: "futura-pt", Futura, "Source Han Sans JP", "Noto Sans JP", sans-serif;
        }
        
        body { margin: 0; padding: 0; background: var(--primary-bg); overflow: hidden; height: 100vh; width: 100vw; position: fixed; }

        .manual-saver-trigger { position: fixed; top: 0; left: 0; width: 80px; height: 80px; z-index: 10000; cursor: pointer; }
        .admin-trigger { position: absolute; top: 15px; right: 15px; width: 50px; height: 50px; background: none; border: none; cursor: pointer; font-size: 28px; color: #eee; z-index: 15000; display: flex; justify-content: center; align-items: center; }

        /* レイアウトGrid：1.8 : 1.2 比率を固定 */
        .app-grid { display: grid; grid-template-columns: 1.8fr 1.2fr; height: 100vh; width: 100vw; }
        
        /* 左パネル：プレビュー */
        .preview-pane { background: #fff; border-right: 1px solid var(--border); position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .title-area { position: absolute; top: 60px; left: 0; width: 100%; height: 60px; display: flex; justify-content: center; z-index: 20; pointer-events: none; }
        .title-img { max-width: 85%; object-fit: contain; }
        
        .preview-outer { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; width: 100%; }
        .default-img { position: absolute; width: 55%; max-height: 40%; object-fit: contain; z-index: 1; transition: opacity 0.8s ease; }
        
        .preview-wrapper { position: absolute; height: 50%; aspect-ratio: 179 / 232; display: flex; justify-content: center; align-items: center; z-index: 2; opacity: 0; }
        .preview-wrapper.animate-on { transition: transform 0.6s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity: 0.4s ease; }
        .preview-wrapper.rise { transform: translateY(-30px) scale(1.15); opacity: 1 !important; filter: drop-shadow(0 30px 20px rgba(0,0,0,0.15)); }

        @keyframes snapLaunch {
            0% { transform: translateY(-30px) scale(1.15); opacity: 1; }
            15% { transform: translateY(20px) scale(1.0); opacity: 1; }
            30% { transform: translateY(-60px) scale(1.2); opacity: 1; }
            100% { transform: translateY(-150vh) scale(0.2); opacity: 0; }
        }
        .preview-wrapper.fly { animation: snapLaunch 1.1s cubic-bezier(0.6, -0.28, 0.735, 0.045) forwards !important; }

        .layer { position: absolute; width: 100%; height: 100%; object-fit: contain; transition: 0.4s ease; }

        /* 右パネル：操作系 */
        .control-pane { background: var(--panel-bg); padding: 60px 40px 40px; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }

        .section { margin-bottom: 30px; }
        .section.locked { opacity: 0.15; pointer-events: none; }
        .section-label { font-size: 15px; font-weight: 900; color: #000; margin-bottom: 12px; display: block; letter-spacing: 0.05em; }
        
        .grid-colors { display: flex; gap: 16px; flex-wrap: wrap; }
        .color-dot { width: 48px; height: 48px; border-radius: 50%; border: 1px solid var(--border); overflow: hidden; background-size: 180%; background-position: center 10%; cursor: pointer; position: relative; }
        .color-dot.active::after { content: ''; position: absolute; inset: 0; border: 3px solid #000; border-radius: 50%; }
        
        .grid-covers { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .cover-item { aspect-ratio: 1.2; border: 1px solid var(--border); border-radius: 12px; background: #fff; display: flex; justify-content: center; align-items: center; padding: 8px; cursor: pointer; }
        .cover-item.active { border: 2.5px solid #000; background: #fafafa; }

        .community-area-box { height: 180px; position: relative; overflow: hidden; background: #fcfcfc; border-radius: 20px; border: 1px dashed var(--border); cursor: grab; touch-action: none; margin-bottom: 20px; }
        #saver-layer { position: fixed; inset: 0; background: #fff; z-index: 9000; display: none; cursor: grab; }
        body.saver-active #saver-layer { display: block; }
        .community-item { position: absolute; width: 34px; height: 44px; pointer-events: none; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .saver-active .community-item { width: 80px; height: 104px; }
        
        #saver-guide { position: fixed; bottom: 50px; right: 50px; width: 400px; opacity: 0; transition: 0.5s; z-index: 11000; pointer-events: none; cursor: pointer; }

        .submit-btn { width: 100%; padding: 24px; background: #000; color: #fff; border: none; border-radius: 20px; font-size: 20px; font-weight: 900; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .submit-btn:disabled { background: var(--disabled); color: #8e8e93; }

        .overlay { position: fixed; inset: 0; background: var(--overlay-dim); z-index: 50000; display: none; justify-content: center; align-items: center; opacity: 0; transition: opacity 0.4s ease; }
        .overlay.show { display: flex; opacity: 1; }
        .survey-card { background: #fff; width: 90%; max-width: 1050px; height: 85%; border-radius: 40px; overflow: hidden; display: grid; grid-template-columns: 1fr 1.2fr; }
        .survey-preview { background: #f9f9f9; display: flex; justify-content: center; align-items: center; padding: 60px; position: relative; }
        .survey-form { padding: 40px 50px; display: flex; flex-direction: column; justify-content: center; overflow-y: auto; }
        .chip { padding: 14px 20px; border: 1px solid var(--border); border-radius: 12px; background: #fff; font-weight: 700; cursor: pointer; font-size: 13px; margin: 0 8px 8px 0; display: inline-block; }
        .chip.active { background: #000; color: #fff; }

        #thanks-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.95); display: none; justify-content: center; align-items: center; z-index: 100; flex-direction: column; opacity: 0; transition: opacity 0.4s ease; }
        #thanks-overlay.show { display: flex; opacity: 1; }
        .admin-menu { background: #fff; padding: 40px; border-radius: 30px; width: 500px; text-align: center; box-shadow: 0 30px 60px rgba(0,0,0,0.1); }
        .admin-btn { width: 100%; padding: 18px; margin: 5px 0; border: 1px solid #ddd; background: #fff; font-weight: 700; border-radius: 15px; cursor: pointer; }
    </style>
</head>
<body onpointerdown="resetInactivityTimer(event)">

<button class="admin-trigger ui-part" onclick="openAdmin()">⚙</button>
<div class="manual-saver-trigger" onclick="startSaver()"></div>

<div id="saver-layer" onpointerdown="onPointerDown(event)">
    <img id="saver-bg-img" src="image/saver_bg.png" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); max-width:60%; opacity:0.05; pointer-events:none;">
</div>
<img id="saver-guide" src="image/guide.png" onpointerdown="stopSaver(event)" onerror="this.style.display='none'">

<div class="app-grid" id="main-container">
    <div class="preview-pane ui-part">
        <div class="title-area"><img src="title.png" class="title-img" onerror="this.style.opacity=0"></div>
        <div class="preview-outer">
            <img id="img-default" src="image/default.png" class="default-img">
            <div id="main-preview" class="preview-wrapper animate-on">
                <img id="img-base" class="layer"><img id="img-cover" class="layer">
            </div>
        </div>
        <div id="thanks-overlay">
            <div style="font-size: 70px;">✓</div>
            <h2 style="font-size: 32px; font-weight: 900;">THANK YOU</h2>
            <p>ご投票ありがとうございました</p>
        </div>
    </div>

    <div class="control-pane ui-part">
        <div class="scroll-area">
            <section class="section" id="section-base">
                <span class="section-label">01. SELECT BODY COLOR</span>
                <div class="grid-colors" id="base-options"></div>
            </section>
            <section class="section locked" id="section-cover">
                <span class="section-label">02. CHOOSE COVER</span>
                <div class="grid-covers" id="cover-options"></div>
            </section>
            <span class="section-label">COMMUNITY</span>
            <div id="community-area" class="community-area-box"></div>
        </div>
        <div id="btn-container">
            <div id="cover-alert" class="alert-text">カバーを選んでください (Please choose a cover)</div>
            <button id="submitBtn" class="submit-btn" onclick="handlePostAction()" disabled><span>POST NOW</span><small style="font-size:11px; font-weight:400;">投稿する</small></button>
        </div>
    </div>
</div>

<div id="survey-overlay" class="overlay">
    <div class="survey-card">
        <div class="survey-preview" id="survey-clone-target"></div>
        <div class="survey-form">
            <h2 style="font-size:32px; font-weight:900;">Help us with our survey!</h2>
            <p style="font-size:14px; color:var(--text-sub); margin-bottom:30px;">アンケートにご協力ください（任意）</p>
            <div id="age-chips"><span class="section-label">年齢 Age</span><div class="chip" onclick="setSurvey('age','30歳未満')">30歳未満</div><div class="chip" onclick="setSurvey('age','30代')">30代</div><div class="chip" onclick="setSurvey('age','40代')">40代</div><div class="chip" onclick="setSurvey('age','50歳以上')">50歳以上</div></div>
            <div id="gender-chips" style="margin-top:20px;"><span class="section-label">性別 Gender</span><div class="chip" onclick="setSurvey('gender','男性')">男性</div><div class="chip" onclick="setSurvey('gender','女性')">女性</div></div>
            <div style="font-size:11px; color:var(--text-sub); margin:20px 0;">[Privacy Policy] Data used only for statistics.</div>
            <label style="display:flex; align-items:center; gap:12px; font-weight:700; margin-bottom:30px;"><input type="checkbox" id="agree-cb" style="width:24px; height:24px;" onchange="updateFinalBtn()"><span>同意して投稿する Agree and Post</span></label>
            <div style="display:flex; gap:15px;"><button class="submit-btn" style="background:#eee; color:#000; flex:1;" onclick="hideSurvey()">Back</button><button id="finalPostBtn" class="submit-btn" style="flex:2;" onclick="executeFinalPost()" disabled>POST NOW</button></div>
        </div>
    </div>
</div>

<div id="admin-overlay" class="overlay">
    <div class="admin-menu">
        <h2 style="margin-bottom:25px">ADMIN SETTINGS</h2>
        <button onclick="downloadCSV()" class="admin-btn">CSV DOWNLOAD</button>
        <button onclick="changePW()" class="admin-btn">CHANGE PASSWORD</button>
        <button onclick="resetData()" class="admin-btn" style="color:red; border-color:red;">RESET DATA</button>
        <button onclick="closeAdmin()" class="admin-btn" style="background:#eee; border:none; margin-top:15px;">CLOSE</button>
    </div>
</div>

<script>
    const CONFIG = { storageKey: 'booth_v93_data', settingsKey: 'booth_v93_set', inactivityLimit: 60000, baseCount: 5, coverMax: 10 };
    let communityItems = [], inactivityTimer, isSaverActive = false, grabbedItem = null;
    let selectedBase = null, selectedCover = null, validCoverIdsForRandom = [];
    let surveyInput = { age: '', gender: '' }, isSurveyEnabled = true;

    function init() {
        const set = JSON.parse(localStorage.getItem(CONFIG.settingsKey) || '{"survey":true, "pw":"1234"}');
        const bc = document.getElementById('base-options');
        for(let i=1; i<=CONFIG.baseCount; i++){
            const d = document.createElement('div'); d.className='color-dot'; d.style.backgroundImage=`url(image/base_${i}.png)`; d.onclick=()=>selectBase(i); bc.appendChild(d);
        }
        const cc = document.getElementById('cover-options');
        for(let i=0; i<=CONFIG.coverMax; i++){
            const itm = document.createElement('div'); itm.className='cover-item';
            if(i===0){ itm.innerHTML=`<span style="font-weight:900;font-size:10px;">REMOVE</span>`; itm.onclick=()=>selectCover(i); cc.appendChild(itm); }
            else {
                const img = new Image(); img.src=`image/cover_${i}.png`; img.className='cover-thumb';
                img.onload=()=>{ itm.appendChild(img); itm.onclick=()=>selectCover(i); cc.appendChild(itm); validCoverIdsForRandom.push(i); };
                img.onerror=()=>itm.remove();
            }
        }
        setTimeout(()=>loadCommunity(true), 1000);
        requestAnimationFrame(updateAnimation);
        resetInactivityTimer();
        [document.getElementById('community-area'), document.getElementById('saver-layer')].forEach(a => a.addEventListener('pointerdown', onPointerDown));
        window.addEventListener('pointermove', onPointerMove); window.addEventListener('pointerup', ()=>grabbedItem=null);
    }

    function handlePostAction() { if (isSurveyEnabled) showSurvey(); else executeFinalPost(); }
    function executeFinalPost() {
        if (isSurveyEnabled) hideSurvey();
        const p = document.getElementById('main-preview');
        p.classList.remove('rise', 'fly'); void p.offsetWidth;
        p.classList.add('fly'); 
        localStorage.setItem(CONFIG.storageKey, JSON.stringify([...JSON.parse(localStorage.getItem(CONFIG.storageKey)||'[]'), {t:new Date().toLocaleString(), b:selectedBase, c:selectedCover, age:surveyInput.age, gen:surveyInput.gender}]));
        setTimeout(() => {
            addCommunityItem(selectedBase, selectedCover, false);
            const th = document.getElementById('thanks-overlay'); th.style.display = 'flex'; setTimeout(() => th.classList.add('show'), 10);
            setTimeout(() => { resetUIState(); th.classList.remove('show'); setTimeout(() => th.style.display = 'none', 400); }, 1600);
        }, 950); 
    }

    function selectBase(id){
        selectedBase = id; document.getElementById('img-default').style.opacity='0'; 
        const p = document.getElementById('main-preview'); p.style.opacity='1'; p.classList.remove('rise', 'fly');
        document.querySelectorAll('.color-dot').forEach((el,idx)=>el.classList.toggle('active', (idx+1)===id));
        document.getElementById('section-cover').classList.remove('locked'); updatePreview();
    }
    function selectCover(id){
        if(!selectedBase) return; selectedCover = id;
        document.querySelectorAll('.cover-item').forEach(el=>{ const isNone=el.innerText.includes('REMOVE')&&id===0; const hasMatch=el.querySelector('img')&&el.querySelector('img').src.includes(`cover_${id}.png`); el.classList.toggle('active', isNone||hasMatch); });
        document.getElementById('submitBtn').disabled = (id===0);
        document.getElementById('cover-alert').classList.toggle('show', id===0); updatePreview();
    }
    function resetUIState(){
        const p = document.getElementById('main-preview'); p.style.opacity='0'; p.classList.remove('rise','fly');
        selectedBase=null; selectedCover=null; document.getElementById('img-default').style.opacity='1';
        document.querySelectorAll('.color-dot, .cover-item, .chip').forEach(el=>el.classList.remove('active'));
        document.getElementById('section-cover').classList.add('locked'); document.getElementById('submitBtn').disabled=true;
    }
    function showSurvey(){
        const target=document.getElementById('survey-clone-target'); target.innerHTML='';
        const clone=document.getElementById('main-preview').cloneNode(true); clone.style.opacity='1'; clone.style.position="relative"; target.appendChild(clone);
        document.getElementById('survey-overlay').classList.add('show');
    }
    function hideSurvey(){ document.getElementById('survey-overlay').classList.remove('show'); }
    function setSurvey(k,v){ surveyInput[k]=v; document.querySelectorAll(`#${k}-chips .chip`).forEach(c=>c.classList.toggle('active', c.innerText.includes(v))); }
    function updateFinalBtn(){ document.getElementById('finalPostBtn').disabled = !document.getElementById('agree-cb').checked; }
    function openAdmin(){ const pw=prompt("PW"); if(pw==="1234") document.getElementById('admin-overlay').classList.add('show'); }
    function closeAdmin(){ document.getElementById('admin-overlay').classList.remove('show'); }

    function onPointerDown(e){
        const target = isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area');
        const rect = target.getBoundingClientRect();
        const tx = ((e.clientX - rect.left) / rect.width) * 100, ty = ((e.clientY - rect.top) / rect.height) * 100;
        let found = null;
        communityItems.forEach(i=>{ const hr = isSaverActive ? 4.5 : 3.5; if(Math.sqrt((tx-i.x)**2+(ty-i.y)**2) < hr) found=i; });
        if(found){ grabbedItem=found; grabbedItem.vx=0; grabbedItem.vy=0; }
        else { communityItems.forEach(i=>{
            const dx=i.x-tx, dy=i.y-ty, d=Math.sqrt(dx*dx+dy*dy), r=isSaverActive?20:15;
            if(d < r){ i.vx+=(dx/d)*(r-d)*0.5; i.vy+=(dy/d)*(r-d)*0.5; i.dr+=(Math.random()-0.5)*10; }
        }); }
    }
    function onPointerMove(e){ 
        if(!grabbedItem)return; 
        const target = isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area');
        const rect = target.getBoundingClientRect();
        const tx=((e.clientX-rect.left)/rect.width)*100, ty=((e.clientY-rect.top)/rect.height)*100;
        grabbedItem.vx = (tx - grabbedItem.x) * 0.8; grabbedItem.vy = (ty - grabbedItem.y) * 0.8;
        grabbedItem.x = tx; grabbedItem.y = ty;
    }
    function updateAnimation(){
        const lx=isSaverActive?94:92, ly=isSaverActive?92:80; 
        communityItems.forEach(i=>{
            if(i !== grabbedItem){ 
                i.x+=(i.dx+i.vx); i.y+=(i.dy+i.vy); i.rot+=i.dr; 
                i.vx*=0.97; i.vy*=0.97; i.dr*=0.95; 
                if(i.x<0||i.x>lx){i.dx*=-1; i.vx*=-0.8;} if(i.y<0||i.y>ly){i.dy*=-1; i.vy*=-0.8;}
            }
            i.el.style.left = i.x + '%'; i.el.style.top = i.y + '%'; i.el.style.transform = `rotate(${i.rot}deg)`;
        });
        requestAnimationFrame(updateAnimation);
    }
    function resetInactivityTimer(){ clearTimeout(inactivityTimer); inactivityTimer=setTimeout(()=>startSaver(), CONFIG.inactivityLimit); }
    function startSaver(){ if(isSaverActive)return; isSaverActive=true; document.body.classList.add('saver-active'); communityItems.forEach(i=>document.getElementById('saver-layer').appendChild(i.el)); document.getElementById('saver-guide').style.opacity=1; document.getElementById('saver-guide').style.pointerEvents='auto'; }
    function stopSaver(e){ if(e)e.stopPropagation(); isSaverActive=false; document.body.classList.remove('saver-active'); communityItems.forEach(i=>document.getElementById('community-area').appendChild(i.el)); document.getElementById('saver-guide').style.opacity=0; document.getElementById('saver-guide').style.pointerEvents='none'; resetInactivityTimer(); }
    function updatePreview(){ document.getElementById('img-base').src=`image/base_${selectedBase}.png`; const c=document.getElementById('img-cover'); if(selectedCover>0){ c.src=`image/cover_${selectedCover}.png`; c.style.opacity="1"; } else { c.style.opacity="0"; } }
    function loadCommunity(it){ if(it){ for(let i=0; i<5; i++) addCommunityItem(Math.floor(Math.random()*5)+1, validCoverIdsForRandom[Math.floor(Math.random()*validCoverIdsForRandom.length)], true); } }
    function addCommunityItem(b,c,i){ 
        const el=document.createElement('div'); el.className='community-item'; if(!i) el.classList.add('new-arrival'); 
        el.innerHTML=`<img src="image/base_${b}.png" style="width:100%;position:absolute;"><img src="image/cover_${c}.png" style="width:100%;position:absolute;opacity:${c===0?0:1}">`; 
        const r=Math.random()*360; el.style.setProperty('--base-rot', r+'deg'); 
        const it={el,x:Math.random()*80,y:Math.random()*70,rot:r,dx:(Math.random()-0.5)*0.06,dy:(Math.random()-0.5)*0.06,dr:0,vx:0,vy:0}; 
        (isSaverActive ? document.getElementById('saver-layer') : document.getElementById('community-area')).appendChild(el); 
        communityItems.push(it); if(communityItems.length>25) communityItems.shift().el.remove(); 
    }
    function downloadCSV(){
        const d = JSON.parse(localStorage.getItem(CONFIG.storageKey)||'[]');
        const csv = "\ufeffTime,Base,Cover,Age,Gender\n" + d.map(i=>`${i.t},${i.b},${i.c},${i.age},${i.gen}`).join("\n");
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv'}));
        a.download = `booth_data.csv`; a.click();
    }
    init();
</script>
</body>
</html>
